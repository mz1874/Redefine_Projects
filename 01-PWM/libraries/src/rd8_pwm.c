//************************************************************
//  Copyright (c) 合肥市新定义电子有限公司
//	文件名称:			rd8_pwm.c
//	作者:					新定义应用团队
//	模块功能:			PWM固件库函数C文件
// 最后更正日期:	2022年6月9日
//	版本:					V1.001
// 说明:该文件仅适用于RD8系列芯片
//*************************************************************

#include "rd8_pwm.h"
//PWM2/3/4与TIM2/3/4共用寄存器
#include "rd8_timer2.h"
#include "rd8_timer3.h"
#include "rd8_timer4.h"

#include "string.h"

#if defined(RD8G36x) || defined(RD8G37x) || defined(RD8T36x) || defined(RD8T37x)

uint16_t xdata PWMREG[14] _at_ 0x2034; //PWM占空比调节寄存器

/**************************************************
*函数名称:void PWM_DeInit(void)
*函数功能:PWM0相关寄存器复位至缺省值
*入口参数:void
*出口参数:void
**************************************************/
void PWM_DeInit(void)
{
  uint8_t i;
  //PWM0相关寄存器清零
  PWMCON0 = 0X00;
  PWMCFG = 0X00;
  PWMCON1 = 0X00;
  PWMPDL = 0x00;
  PWMPDH = 0x00;
  IE1 &= 0XFD;
  IP1 &= 0XFD;

  //占空比寄存器
  for(i = 0; i < 8; i++)
  {
    *(&PWMREG[6] + i) = 0;
  }
}

/**************************************************
*函数名称:void PWM_InitEX(PWM_Type_TypeDef PWM_Type)
*函数功能:PWM0相关寄存器复位至缺省值
*入口参数:
PWM_Type_TypeDef:PWM_Type:PWM源
*出口参数:void
**************************************************/
void PWM_DeInitEX(PWM_Type_TypeDef PWM_Type)
{
  /* PWM0相关寄存器复位到保留值 */
  if(PWM_Type == PWM0_Type)
  {
    uint8_t i;

    //PWM0相关寄存器清零
    PWMCON0 = 0X00;
    PWMCFG = 0X00;
    PWMCON1 = 0X00;
    PWMPDL = 0x00;
    PWMPDH = 0x00;
    IE1 &= 0XFD;
    IP1 &= 0XFD;

    //占空比寄存器
    for(i = 0; i < 8; i++)
    {
      *(&PWMREG[6] + i) = 0;
    }
  }
  else /* PWM2/3/4相关寄存器复位到保留值 */
  {
    TXINX = PWM_Type;
    TXCON &= ~0x04;
    TXMOD &= ~0x3C;

    switch(PWM_Type)
    {
      case PWM2_Type:
        ET2 = 0;
        IP &= ~0x20;
        (uint32_t)PWMREG[0] = 0;
        break;
      case PWM3_Type:
        IE1 &= ~0x40;
        IP1 &= ~0x40;
        (uint32_t)PWMREG[2] = 0;
        break;
      case PWM4_Type:
        IE1 &= ~0x80;
        IP1 &= ~0x80;
        (uint32_t)PWMREG[4] = 0;
        break;
    }
  }
}

/**************************************************
*函数名称:PWM_Init(PWM_Type_TypeDef PWM_Type,PWM_PresSel_TypeDef PWM_PresSel, uint16_t PWM_Period)
*函数功能:PWM初始化配置函数
*入口参数:
PWM_PresSel_TypeDef:PWM_PresSel:预分频选择
uint16_t:PWM_Period:PWM周期配置
*出口参数:void
**************************************************/
void PWM_Init(PWM_PresSel_TypeDef PWM_PresSel, uint16_t PWM_Period)
{
  if((PWM_PresSel & 0X0F) == PWM0_Type)
  {
    PWM_Period -= 1;
    PWMCON0 = (PWMCON0 & 0XCF) | (PWM_PresSel & 0XF0); //预分频
    PWMPDH = (uint8_t)(PWM_Period >> 8);               //周期高8位
    PWMPDL = (uint8_t)(PWM_Period & 0X00FF);           //周期低8位
  }
  else
  {
    TXINX = (PWM_PresSel & 0X0F);							//控制寄存器指针指向对应的PWM源
    PWM_PresSel = DISABLE;										//PWM2分频唯一，不用设置
    RCAPXH = (uint8_t)(PWM_Period >> 8);			//周期高8位
    RCAPXL = (uint8_t)(PWM_Period & 0X00FF);	//周期低8位
  }
}

/*****************************************************
*函数名称:void PWM_Aligned_Mode_Select(void)
*函数功能:选择PWM的对齐模式
*入口参数:
PWM_Aligned_Mode_TypeDef:PWM_Aligned_Mode:选择对齐模式
*出口参数:void
*****************************************************/
void PWM_Aligned_Mode_Select(PWM_Aligned_Mode_TypeDef PWM_Aligned_Mode)
{

  //PWM0选择对齐模式配置
  if(PWM_Aligned_Mode == PWM0_Edge_Aligned_Mode)
  {
    PWMCON0 &= 0XFE;
  }
  else if(PWM_Aligned_Mode == PWM0_Center_Alignment_Mode)
  {
    PWMCON0 |= 0X01;
  }
}

/**************************************************
*函数名称:void PWM_OutputStateConfig(uint8_t PWM_OutputPin, PWM_OutputState_TypeDef PWM_OutputState)
*函数功能:PWMx输出使能/失能配置函数
*入口参数:
PWM_OutputPin_TypeDef:PWM_OutputPin:PWMx选择（uint8_t作为入参，方便进行位或操作）
PWM_OutputState_TypeDef:PWM_OutputState:PWM输出状态配置
*出口参数:void
**************************************************/
void PWM_OutputStateConfig(uint8_t PWM_OutputPin,
                           PWM_OutputState_TypeDef PWM_OutputState)
{
  unsigned char Reg_Data;
  if((PWM_OutputPin & 0xF0) == 0x00)
  {
    if(PWM_OutputState == PWM_OUTPUTSTATE_ENABLE)
    {
      PWMCON1 |= 1 << (PWM_OutputPin & 0x0F);
    }
    else
    {
      PWMCON1 &= ~(1 << (PWM_OutputPin & 0x0F));
    }
  }
  else
  {
    TXINX = (PWM_OutputPin & 0xF0) >> 4;

    if(PWM_OutputPin & 0x01)
    {
      Reg_Data = 0x20;
    }
    else
    {
      Reg_Data = 0x10;
    }

    if(PWM_OutputState == PWM_OUTPUTSTATE_ENABLE)
    {
      TXMOD |= Reg_Data;
    }
    else
    {
      TXMOD &= ~Reg_Data;
    }
  }
}

/**************************************************
*函数名称:void PWM_PolarityConfig(PWM_OutputPin_TypeDef PWM_OutputPin, PWM_Polarity_TypeDef PWM_Polarity)
*函数功能:PWMx正/反向输出配置函数
*入口参数:
PWM_OutputPin_TypeDef:PWM_OutputPin:PWMx选择（uint8_t作为入参，方便进行位或操作）
PWM_Polarity_TypeDef:PWM_Polarity:PWM输出正/反向配置
*出口参数:void
**************************************************/
void PWM_PolarityConfig(uint8_t PWM_OutputPin,
                        PWM_Polarity_TypeDef PWM_Polarity)
{
  unsigned char Reg_Data;
  if((PWM_OutputPin & 0xF0) == 0x00)
  {
    if(PWM_Polarity == PWM_POLARITY_INVERT)
    {
      PWMCFG |= 1 << (PWM_OutputPin & 0x0F);
    }
    else
    {
      PWMCFG &= ~(1 << (PWM_OutputPin & 0x0F));
    }
  }
  else
  {
    TXINX = (PWM_OutputPin & 0xF0) >> 4;

    if(PWM_OutputPin & 0x0F)
    {
      Reg_Data = 0x08;
    }
    else
    {
      Reg_Data = 0x04;
    }

    if(PWM_Polarity == PWM_POLARITY_INVERT)
    {
      TXMOD |= Reg_Data;
    }
    else
    {
      TXMOD &= ~Reg_Data;
    }
  }
}

/**************************************************
*函数名称:void PWM_IndependentModeConfig(PWM_OutputPin_TypeDef PWM_OutputPin, uint16_t PWM_DutyCycle)
*函数功能:PWMx独立工作模式占空比配置函数
*入口参数:
PWM_OutputPin_TypeDef:PWM_OutputPin:PWMx独立通道选择
uint16_t:PWM_DutyCycle:PWM占空比配置
*出口参数:void
**************************************************/
void PWM_IndependentModeConfig(PWM_OutputPin_TypeDef PWM_OutputPin, uint16_t PWM_DutyCycle)
{
  if((PWM_OutputPin & 0xF0) == 0x00)
  {
    PWMCON0 &= ~0x02;				//配置为互补模式
    PWMREG[6 + PWM_OutputPin] = PWM_DutyCycle;
  }
  else
  {
    PWMREG[PWM_OutputPin & 0x0F] = PWM_DutyCycle;
  }
}

/**************************************************
*函数名称:void PWM_ComplementaryModeConfig(PWM_ComplementaryOutputPin_TypeDef PWM_ComplementaryOutputPin, uint16_t PWM_DutyCycle)
*函数功能:PWMxPWMy互补工作模式配置函数
*入口参数:
PWM_ComplementaryOutputPin_TypeDef:PWM_ComplementaryOutputPin:PWMxPWMy互补通道选择
uint16_t:PWM_DutyCycle:PWM占空比配置
*出口参数:void
**************************************************/
void PWM_ComplementaryModeConfig(PWM_ComplementaryOutputPin_TypeDef PWM_ComplementaryOutputPin,
                                 uint16_t PWM_DutyCycle)
{
  PWMCON0 |= 0x02;				//配置为独立模式
  PWMREG[6 + PWM_ComplementaryOutputPin] = PWM_DutyCycle;
}

/**************************************************
*函数名称:void PWM_DeadTimeConfig(uint8_t PWM_RisingDeadTime, uint8_t PWM_FallingDeadTime)
*函数功能:PWM互补工作模式下死区时间配置函数
*入口参数:
uint8_t:PWM_RisingDeadTime:PWM死区上升时间00-FF
uint8_t:PWM_FallingDeadTime:PWM死区下降时间00-FF
*出口参数:void
**************************************************/
void PWM_DeadTimeConfig(uint8_t PWM_RisingDeadTime, uint8_t PWM_FallingDeadTime)
{
  PWMDFR = (PWM_RisingDeadTime | (PWM_FallingDeadTime << 4));
}

/**************************************************
*函数名称:PWM_DeadTimeConfigEX(PWM_Type_TypeDef PWM_Type,uint8_t PWM_RisingDeadTime, uint8_t PWM_FallingDeadTime)
*函数功能:PWM互补工作模式下死区时间配置函数-扩展版
*入口参数:
PWM_Type_TypeDef:PWM_Type:PWM源选择
uint8_t:PWM_RisingDeadTime:PWM死区上升时间	 00-FF
uint8_t:PWM_FallingDeadTime:PWM死区下降时间  00-FF
*出口参数:void
**************************************************/
void PWM_DeadTimeConfigEX(PWM_Type_TypeDef PWM_Type, uint8_t PWM_RisingDeadTime, uint8_t PWM_FallingDeadTime)
{
  if(PWM_Type == PWM0_Type)
  {
    PWMDFR = (PWM_RisingDeadTime | (PWM_FallingDeadTime << 4));
  }
}

/*****************************************************
*函数名称:void PWM_Cmd(FunctionalState NewState)
*函数功能:PWM功能开关函数
*入口参数:
FunctionalState:NewState:功能启动/关闭选择
*出口参数:void
*****************************************************/
void PWM_Cmd(FunctionalState NewState)
{
  if(NewState != DISABLE)
  {
    PWMCON0 |= 0X80;
  }
  else
  {
    PWMCON0 &= 0X7F;
  }
}

/*****************************************************
*函数名称:void PWM_CmdEX(PWM_Type_TypeDef PWM_Type,FunctionalState NewState)
*函数功能:PWM功能开关函数-扩展版
*入口参数:
PWM_Type_TypeDef:PWM_Type:PWM类型
FunctionalState:NewState:功能启动/关闭选择
*出口参数:void
*****************************************************/
void PWM_CmdEX(PWM_Type_TypeDef PWM_Type,
               FunctionalState NewState)
{
  if(PWM_Type == PWM0_Type)
  {
    if(NewState != DISABLE)
    {
      PWMCON0 |= 0X80;
    }
    else
    {
      PWMCON0 &= 0X7F;
    }
  }
  else
  {
    TXINX = PWM_Type;
    if(NewState != DISABLE)
    {
      TXCON |= 0X04;
    }
    else
    {
      TXCON &= ~0X04;
    }
  }
}

/*****************************************************
*函数名称:void PWM_ITConfig(FunctionalState NewState, PriorityStatus Priority)
*函数功能:PWM中断初始化
*入口参数:
FunctionalState:NewState:中断使能/关闭选择
PriorityStatus:Priority:中断优先级选择
*出口参数:void
*****************************************************/
void PWM_ITConfig(FunctionalState NewState,
                  PriorityStatus Priority)
{
  if(NewState != DISABLE)
  {
    IE1 |= 0X02;
  }
  else
  {
    IE1 &= 0XFD;
  }

  if(Priority == LOW)
  {
    IP1 &= ~0X02;
  }
  else
  {
    IP1 |= 0X02;
  }
}


/*****************************************************
*函数名称:void PWM_ITConfigEX(PWM_Type_TypeDef PWM_Type,FunctionalState NewState, PriorityStatus Priority)
*函数功能:PWM中断配置函数-扩展版
*入口参数:
PWM_Type_TypeDef:PWM_Type:PWM源选择
FunctionalState:NewState:中断使能/关闭选择
PriorityStatus:Priority:中断优先级选择
*出口参数:void
*****************************************************/
void PWM_ITConfigEX(PWM_Type_TypeDef PWM_Type, FunctionalState NewState, PriorityStatus Priority)
{
  switch(PWM_Type)
  {
    case PWM0_Type:
      PWM_ITConfig(NewState, Priority);
      break;
    case PWM2_Type:
    {
      if(NewState == DISABLE)
        ET2 = 0;
      else
        ET2 = 1;

      if(Priority == LOW)
        IPT2 = 0;
      else
        IPT2 = 1;
    }
    break;
    case PWM3_Type:
    {
      if(NewState == DISABLE)
        IE1 &= 0XBF;
      else
        IE1 |= 0X40;

      if(Priority == LOW)
        IP1 &= 0XBF;
      else
        IP1 |= 0X40;
    }
    break;
    case PWM4_Type:
    {
      if(NewState == DISABLE)
        IE1 &= 0X7F;
      else
        IE1 |= 0X80;

      if(Priority == LOW)
        IP1 &= 0X7F;
      else
        IP1 |= 0X80;
    }
    break;
    default:
      break;
  }
}

/*****************************************************
*函数名称:void PWM_IndependentModeConfigEX(PWM_OutputPin_TypeDef PWM_OutputPin, uint16_t PWM_DutyCycle, PWM_OutputState_TypeDef PWM_OutputState)
*函数功能:PWM独立模式占空比配置-扩展版
*入口参数:
PWM_OutputPin_TypeDef:PWM_ComplementaryOutputPin:PWM通道
uint16_t:PWM_DutyCycle:PWM占空比配置
FunctionalState:NewState:功能启动/关闭选择
*出口参数:void
*****************************************************/
void PWM_IndependentModeConfigEX(PWM_OutputPin_TypeDef PWM_ComplementaryOutputPin,
                                 uint16_t PWM_DutyCycle,
                                 PWM_OutputState_TypeDef PWM_OutputState)
{
  PWM_IndependentModeConfig(PWM_ComplementaryOutputPin, PWM_DutyCycle); //配置占空比
  PWM_OutputStateConfig(PWM_ComplementaryOutputPin, PWM_OutputState);   //IO复用PWM配置函数
  if(PWM_OutputState == ENABLE)
  {
    PWM_CmdEX(PWM_ComplementaryOutputPin >> 4, ENABLE); //开启PWM
  }
}

/*****************************************************
*函数名称:void PWM_ComplementaryModeConfigEX(PWM_OutputPin_TypeDef PWM_OutputPin, uint16_t PWM_DutyCycle, PWM_OutputState_TypeDef PWM_OutputState)
*函数功能:PWM互补模式占空比配置-扩展版
*入口参数:
PWM_ComplementaryOutputPin_TypeDef:PWM_OutputPin:PWM通道
uint16_t:PWM_DutyCycle:PWM占空比配置
FunctionalState:NewState:功能启动/关闭选择
*出口参数:void
*****************************************************/
void PWM_ComplementaryModeConfigEX(PWM_ComplementaryOutputPin_TypeDef PWM_OutputPin,
                                   uint16_t PWM_DutyCycle,
                                   PWM_OutputState_TypeDef PWM_OutputState)
{
  PWM_ComplementaryModeConfig(PWM_OutputPin, PWM_DutyCycle); //配置占空比
  PWM_OutputStateConfig(PWM_OutputPin, PWM_OutputState);     //IO复用PWM配置函数
  PWM_OutputStateConfig(PWM_OutputPin + 2, PWM_OutputState); //IO复用PWM配置函数
  if(PWM_OutputState == ENABLE)
  {
    PWM_CmdEX(PWM_OutputPin >> 4, ENABLE); //开启PWM
  }
}

/*****************************************************
*函数名称:PWM_GetFlagStatus(void)
*函数功能:获取PWM中断标志位
*入口参数:void
*出口参数:
FlagStatus：PWM中断标志位状态
*****************************************************/
FlagStatus PWM_GetFlagStatus(void)
{
  return (bool)(PWMCON0 & 0X40);
}

/*****************************************************
*函数名称:PWM_GetFlagStatusEX(PWM_Type_TypeDef PWM_Type)
*函数功能:获取PWM中断标志位-扩展版
*入口参数:
PWM_Type_TypeDef:PWM_Type:PWM源选择
*出口参数:
FlagStatus：PWM中断标志位状态
*****************************************************/
FlagStatus PWM_GetFlagStatusEX(PWM_Type_TypeDef PWM_Type)
{
  if((PWM_Type == PWM0_Type))
  {
    return (bool)(PWMCON0 & 0X40);
  }
  else if((PWM_Type == PWM2_Type) || (PWM_Type == PWM3_Type) || (PWM_Type == PWM0_Type))
  {
    TXINX = PWM_Type;
    return (bool)(TXCON & 0x80);
  }

  return RESET;
}

/*****************************************************
*函数名称:void PWM_ClearFlag(void)
*函数功能:清除PWM0中断标志位
*入口参数:void
*出口参数:void
*****************************************************/
void PWM_ClearFlag(void)
{
  PWMCON0 &= ~0X40;
}

/*****************************************************
*函数名称:void PWM_ClearFlagEX(PWM_Type_TypeDef PWM_Type)
*函数功能:清除PWM0中断标志位-扩展版
*入口参数:
PWM_Type_TypeDef:PWM_Type:PWM源选择
*出口参数:void
*****************************************************/
void PWM_ClearFlagEX(PWM_Type_TypeDef PWM_Type)
{
  if((PWM_Type == PWM0_Type))
  {
    PWMCON0 &= ~0X40;
  }
  else if((PWM_Type == PWM2_Type) || (PWM_Type == PWM3_Type) || (PWM_Type == PWM0_Type))
  {
    TXINX = PWM_Type;
    TXCON &= ~0x80;
  }
}

/*****************************************************
*函数名称:FlagStatus PWM_GetFaultDetectionFlagStatus(void)
*函数功能:获得PWM故障检测标志位状态
*入口参数:void
*出口参数:
FlagStatus:PWM故障检测标志位状态
*****************************************************/
FlagStatus PWM_GetFaultDetectionFlagStatus(void)
{
  return (bool)(PWMFLT & 0X40);
}

/*****************************************************
*函数名称:PWM_GetFaultDetectionFlagStatusEX(PWM_Type_TypeDef PWM_Type)
*函数功能:获得PWM故障检测标志位状态-扩展版
*入口参数:
PWM_Type_TypeDef:PWM_Type:PWM类型
*出口参数:
FlagStatus:PWM故障检测标志位状态
*****************************************************/
FlagStatus PWM_GetFaultDetectionFlagStatusEX(PWM_Type_TypeDef PWM_Type)
{
  if(PWM_Type == PWM0_Type)
  {
    return (bool)(PWMFLT & 0X40);
  }
  return RESET;
}

/*****************************************************
*函数名称:void PWM_ClearFaultDetectionFlag(void)
*函数功能:清除PWM0故障检测标志位状态   // ！注意,处于锁存模式下，此位需要软件清除
*入口参数:
PWM_Type_TypeDef:PWM_Type:PWM类型
*出口参数:void
*****************************************************/
void PWM_ClearFaultDetectionFlag(void)
{
  PWMFLT &= 0XBF;
}

/*****************************************************
*函数名称:void PWM_ClearFaultDetectionFlagEX(PWM_Type_TypeDef PWM_Type)
*函数功能:清除PWM故障检测标志位状态-扩展版   // ！注意,处于锁存模式下，此位需要软件清除
*入口参数:
PWM_Type_TypeDef:PWM_Type:PWM类型
*出口参数:void
*****************************************************/
void PWM_ClearFaultDetectionFlagEX(PWM_Type_TypeDef PWM_Type)
{
  if(PWM_Type == PWM0_Type)
  {
    PWMFLT &= 0XBF;
  }
}

/*****************************************************
*函数名称:void PWM_FaultDetectionConfig(FunctionalState NewState)
*函数功能:PWM故障检测功能开启/关闭
*入口参数:
FunctionalState:NewState:故障检测功能开启/关闭
*出口参数:void
*****************************************************/
void PWM_FaultDetectionConfig(FunctionalState NewState)
{
  if(NewState != DISABLE)
  {
    PWMFLT |= 0X80;
  }
  else
  {
    PWMFLT &= 0X7F;
  }
}

/*****************************************************
*函数名称:void PWM_FaultDetectionFunctionConfigEX(PWM_Type_TypeDef PWM_Type, FunctionalState NewState)
*函数功能:PWM故障检测功能开启/关闭-扩展版
*入口参数:
PWM_Type_TypeDef:PWM_Type:PWM类型选择
FunctionalState:NewState:故障检测功能开启/关闭
*出口参数:void
*****************************************************/
void PWM_FaultDetectionConfigEX(PWM_Type_TypeDef PWM_Type, FunctionalState NewState)
{
  if(PWM_Type == PWM0_Type)
  {
    if(NewState != DISABLE)
    {
      PWMFLT |= 0X80;
    }
    else
    {
      PWMFLT &= 0X7F;
    }
  }
}

/*****************************************************
*函数名称:void PWM_FaultDetectionModeConfig(PWM_FaultDetectionMode_TypeDef FaultDetectionMode,
*                                    PWM_FaultDetectionVoltageSelect_TypeDef FaultDetectionVoltageSelect,
*                                    PWM_FaultDetectionWaveFilteringTime_TypeDef FaultDetectionWaveFilteringTime)
*函数功能:PWM故障检测模式设置-扩展版
*入口参数:
PWM_FaultDetectionMode_TypeDef:FaultDetectionMode:故障检测功能模式设置: 立即模式/锁存模式
PWM_FaultDetectionVoltageSelect_TypeDef:FaultDetectionVoltageSelect:故障检测电平选择
PWM_FaultDetectionWaveFilteringTime_TypeDef:FaultDetectionWaveFilteringTime:故障检测输入信号滤波时间选择
*出口参数:void
*****************************************************/
void PWM_FaultDetectionModeConfig(PWM_FaultDetectionMode_TypeDef FaultDetectionMode,
                                  PWM_FaultDetectionVoltageSelect_TypeDef FaultDetectionVoltageSelect,
                                  PWM_FaultDetectionWaveFilteringTime_TypeDef FaultDetectionWaveFilteringTime)
{
  PWMFLT = (PWMFLT & 0XC0) | FaultDetectionMode | FaultDetectionVoltageSelect |
           FaultDetectionWaveFilteringTime;
}

/*****************************************************
*函数名称:void PWM_FaultDetectionModeConfigEX(PWM_Type_TypeDef PWM_Type, PWM_FaultDetectionMode_TypeDef FaultDetectionMode, PWM_FaultDetectionVoltageSelect_TypeDef FaultDetectionVoltageSelect, PWM_FaultDetectionWaveFilteringTime_TypeDef FaultDetectionWaveFilteringTime)
*函数功能:PWM故障检测模式设置-扩展版
*入口参数:
PWM_Type_TypeDef:PWM_Type:PWM类型选择
PWM_FaultDetectionMode_TypeDef:FaultDetectionMode:故障检测功能模式设置: 立即模式/锁存模式
PWM_FaultDetectionVoltageSelect_TypeDef:FaultDetectionVoltageSelect:故障检测电平选择
PWM_FaultDetectionWaveFilteringTime_TypeDef:FaultDetectionWaveFilteringTime:故障检测输入信号滤波时间选择
*出口参数:void
*****************************************************/
void PWM_FaultDetectionModeConfigEX(PWM_Type_TypeDef PWM_Type,
                                    PWM_FaultDetectionMode_TypeDef FaultDetectionMode,
                                    PWM_FaultDetectionVoltageSelect_TypeDef FaultDetectionVoltageSelect,
                                    PWM_FaultDetectionWaveFilteringTime_TypeDef FaultDetectionWaveFilteringTime)
{
  if(PWM_Type == PWM0_Type)
  {
    PWMFLT = (PWMFLT & 0XC0) | FaultDetectionMode | FaultDetectionVoltageSelect |
             FaultDetectionWaveFilteringTime;
  }
}

/*****************************************************
*函数名称:void PWM_DutyChange_Ex(void)
*函数功能:PWM独立模式占空比修改
*入口参数:
PWM_OutputPin_TypeDef:PWM_OutputPin:待修改的PWM独立通道
PWM_DutyChange_TypeDef:Change_Direction:PWM修改方向
uint16_t:DutyIncremental:修改的增量
*出口参数:
ErrorStatus:操作成功/失败
*****************************************************/
ErrorStatus PWM_IndependentMode_DutyChange(PWM_OutputPin_TypeDef PWM_OutputPin,
    PWM_DutyChange_TypeDef Change_Direction, uint16_t DutyIncremental)
{
  uint16_t tmpRegValue;
  uint16_t tmpRegAdress;
  uint16_t tmpPolarity = PWMPDL + (PWMPDH << 8);

  /* PWM0的输出通道 */
  if((PWM_OutputPin & 0xF0) == 0x00)
  {
    PWMCON0 &= ~0x02;			//配置为互补模式
    tmpRegAdress = PWMREG + 6 + PWM_OutputPin;
  }
  else		/* PWM2/3/4的占空比寄存器地址 */
  {
    tmpRegAdress = PWMREG + (PWM_OutputPin & 0x0F);
  }

  tmpRegValue = *((uint16_t xdata*)tmpRegAdress);
  if(Change_Direction == PWM_DutyChange_Up)
  {
    tmpRegValue += DutyIncremental;				//占空比增加
  }
  else
  {
    tmpRegValue -= DutyIncremental;				//占空比减少
  }
  /* 计数器发生了溢出 */
  if(tmpRegValue > tmpPolarity)
    return ERROR;
  *((uint16_t xdata*)tmpRegAdress) = tmpRegValue;		//占空比寄存器赋值
  return SUCCESS;
}

/*****************************************************
*函数名称:void PWM_DutyChange_Ex(void)
*函数功能:PWM互补模式占空比修改
*入口参数:
PWM_OutputPin_TypeDef:PWM_OutputPin:待修改的PWM互补通道
PWM_DutyChange_TypeDef:Change_Direction:PWM修改方向
uint16_t:DutyIncremental:修改的增量
*出口参数:
ErrorStatus:操作成功/失败
*****************************************************/
ErrorStatus PWM_ComplementaryMode_DutyChange(PWM_ComplementaryOutputPin_TypeDef PWM_ComplementaryOutputPin, PWM_DutyChange_TypeDef Change_Direction, uint16_t DutyIncremental)
{
  uint16_t tmpRegValue;
  uint16_t tmpRegAdress;
  uint16_t tmpPolarity = PWMPDL + (PWMPDH << 8);
  /* PWM0的占空比寄存器地址 */
  if((PWM_ComplementaryOutputPin & 0xF0) == 0x00)
  {
    tmpRegAdress = PWMREG + 6 + PWM_ComplementaryOutputPin;
  }
  else	/* PWM2/3/4的占空比寄存器地址 */
  {
    tmpRegAdress = PWMREG + (PWM_ComplementaryOutputPin & 0x0F);
  }

  tmpRegValue = *(uint16_t xdata*)tmpRegAdress;
  if(Change_Direction == PWM_DutyChange_Up)
  {
    tmpRegValue += DutyIncremental;				//占空比增加
  }
  else
  {
    tmpRegValue -= DutyIncremental;				//占空比减少
  }
  /* 计数器发生了溢出 */
  if(tmpRegValue > tmpPolarity)
    return ERROR;
  *((uint16_t xdata*)tmpRegAdress) = tmpRegValue;		//占空比寄存器赋值
  return SUCCESS;
}

#endif
#if defined(RD8G05x) || defined(RD8T05x)
uint16_t xdata PWMREG[8] _at_ 0x0F40; //PWM占空比调节寄存器
/**************************************************
*函数名称:void PWM_DeInit(void)
*函数功能:PWM相关寄存器复位至缺省值
*入口参数:void
*出口参数:void
**************************************************/
void PWM_DeInit(void)
{
  uint8_t i;

  //PWM0相关寄存器清零
  PWMCON0 = 0X00;
  PWMCFG = 0X00;
  PWMCON1 = 0X00;
  PWMPDL = 0x00;
  PWMPDH = 0x00;
  IE1 &= 0XFD;
  IP1 &= 0XFD;

  //占空比寄存器
  for(i = 0; i < 8; i++)
  {
    PWMREG[i] = 0;
  }
}

/**************************************************
*函数名称:void PWM_InitEX(PWM_Type_TypeDef PWM_Type)
*函数功能:PWM0相关寄存器复位至缺省值-扩展版
*入口参数:
PWM_Type_TypeDef:PWM_Type:PWM源
*出口参数:void
**************************************************/
void PWM_DeInitEX(PWM_Type_TypeDef PWM_Type)
{
  if(PWM_Type == PWM0_Type)
  {
    uint8_t i;

    //PWM0相关寄存器清零
    PWMCON0 = 0X00;
    PWMCFG = 0X00;
    PWMCON1 = 0X00;
    PWMPDL = 0x00;
    PWMPDH = 0x00;
    IE1 &= 0XFD;
    IP1 &= 0XFD;

    //占空比寄存器
    for(i = 0; i < 8; i++)
    {
      PWMREG[i] = 0;
    }
  }
}
/**************************************************
*函数名称:PWM_Init(PWM_Type_TypeDef PWM_Type,PWM_PresSel_TypeDef PWM_PresSel, uint16_t PWM_Period)
*函数功能:PWM初始化配置函数
*入口参数:
PWM_PresSel_TypeDef:PWM_PresSel:预分频选择
uint16_t:PWM_Period:PWM周期配置
*出口参数:void
**************************************************/
void PWM_Init(PWM_PresSel_TypeDef PWM_PresSel, uint16_t PWM_Period)
{
  /* PWM0时基初始化 */
  PWM_Period -= 1;
  PWMCON0 = ((PWMCON0 & 0XCF) | PWM_PresSel); //预分频
  PWMPDH = (uint8_t)(PWM_Period >> 8);               //周期高8位
  PWMPDL = (uint8_t)(PWM_Period & 0X00FF);           //周期低8位
}

/*****************************************************
*函数名称:void PWM_Aligned_Mode_Select(void)
*函数功能:选择PWM的对齐模式
*入口参数:
PWM_Aligned_Mode_TypeDef:PWM_Aligned_Mode:选择对齐模式
*出口参数:void
*****************************************************/
void PWM_Aligned_Mode_Select(PWM_Aligned_Mode_TypeDef PWM_Aligned_Mode)
{
  PWMCON0 &= ~0x01;	//清除PWM对齐模式配置
  PWMCON0 |= (PWM_Aligned_Mode << 1);	//设置PWM对齐模式
}

/**************************************************
*函数名称:void PWM_OutputStateConfig(uint8_t PWM_OutputPin, PWM_OutputState_TypeDef PWM_OutputState)
*函数功能:PWMx输出使能/失能配置函数
*入口参数:
PWM_OutputPin_TypeDef:PWM_OutputPin:PWMx选择（uint8_t作为入参，方便进行位或操作）
PWM_OutputState_TypeDef:PWM_OutputState:PWM输出状态配置
*出口参数:void
**************************************************/
void PWM_OutputStateConfig(uint8_t PWM_OutputPin,
                           PWM_OutputState_TypeDef PWM_OutputState)
{
  /* PWM0输出通道使能配置 */
  if(PWM_OutputState == PWM_OUTPUTSTATE_ENABLE)
  {
    PWMCON1 |= 1 << (PWM_OutputPin & 0x0F);
  }
  else
  {
    PWMCON1 &= ~(1 << (PWM_OutputPin & 0x0F));
  }
}

/**************************************************
*函数名称:void PWM_PolarityConfig(PWM_OutputPin_TypeDef PWM_OutputPin, PWM_Polarity_TypeDef PWM_Polarity)
*函数功能:PWMx正/反向输出配置函数
*入口参数:
PWM_OutputPin_TypeDef:PWM_OutputPin:PWMx选择（uint8_t作为入参，方便进行位或操作）
PWM_Polarity_TypeDef:PWM_Polarity:PWM输出正/反向配置
*出口参数:void
**************************************************/
void PWM_PolarityConfig(uint8_t PWM_OutputPin,
                        PWM_Polarity_TypeDef PWM_Polarity)
{
  if(PWM_Polarity == PWM_POLARITY_INVERT)
  {
    PWMCFG |= 1 << (PWM_OutputPin & 0x0F);
  }
  else
  {
    PWMCFG &= ~(1 << (PWM_OutputPin & 0x0F));
  }
}

/**************************************************
*函数名称:void PWM_IndependentModeConfig(PWM_OutputPin_TypeDef PWM_OutputPin, uint16_t PWM_DutyCycle)
*函数功能:PWMx独立工作模式配置函数
*入口参数:
PWM_OutputPin_TypeDef:PWM_OutputPin:PWMx独立通道选择
uint16_t:PWM_DutyCycle:PWM占空比配置
*出口参数:void
**************************************************/
void PWM_IndependentModeConfig(PWM_OutputPin_TypeDef PWM_OutputPin, uint16_t PWM_DutyCycle)
{
  PWMCON0 &= ~0x02;	//设置PWM为互补模式
  /* 设置PWM周期 */
  PWMREG[PWM_OutputPin] = PWM_DutyCycle;

}

/**************************************************
*函数名称:void PWM_ComplementaryModeConfig(PWM_ComplementaryOutputPin_TypeDef PWM_ComplementaryOutputPin, uint16_t PWM_DutyCycle)
*函数功能:PWMxPWMy互补工作模式配置函数
*入口参数:
PWM_ComplementaryOutputPin_TypeDef:PWM_ComplementaryOutputPin:PWMxPWMy互补通道选择
uint16_t:PWM_DutyCycle:PWM占空比配置
*出口参数:void
**************************************************/
void PWM_ComplementaryModeConfig(PWM_ComplementaryOutputPin_TypeDef PWM_ComplementaryOutputPin,
                                 uint16_t PWM_DutyCycle)
{
  PWMCON0 |= 0x02;
  PWMREG[PWM_ComplementaryOutputPin] = PWM_DutyCycle;
}

/*****************************************************
*函数名称:void PWM_DutyChange_Ex(void)
*函数功能:PWM独立模式占空比修改
*入口参数:
PWM_OutputPin_TypeDef:PWM_OutputPin:待修改的PWM独立通道
PWM_DutyChange_TypeDef:Change_Direction:PWM修改方向
uint16_t:DutyIncremental:修改的增量
*出口参数:
ErrorStatus:操作成功/失败
*****************************************************/
ErrorStatus PWM_IndependentMode_DutyChange(PWM_OutputPin_TypeDef PWM_OutputPin,
    PWM_DutyChange_TypeDef Change_Direction, uint16_t DutyIncremental)
{
  uint8_t i;
  uint8_t tmpRegValue;

  for(i = 0; i < 8; i++)
  {
    if(PWM_OutputPin & (0x01 << i))
    {
      tmpRegValue = PWMREG[i];			//把当前占空比寄存器放进临时变量
      if(Change_Direction == PWM_DutyChange_Up)
      {
        tmpRegValue += DutyIncremental;				//占空比增加

        /* 计数器发生了向上溢出 */
        if(tmpRegValue < PWMREG[i])
          return ERROR;
      }
      else
      {
        tmpRegValue -= DutyIncremental;				//占空比减少

        /* 计数器发生了向下溢出 */
        if(tmpRegValue < PWMREG[i])
          return ERROR;
      }
      PWMREG[i] = tmpRegValue;		//占空比寄存器赋值
    }
  }
  return SUCCESS;
}

/*****************************************************
*函数名称:void PWM_DutyChange_Ex(void)
*函数功能:PWM互补模式占空比修改
*入口参数:
PWM_OutputPin_TypeDef:PWM_OutputPin:待修改的PWM互补通道
PWM_DutyChange_TypeDef:Change_Direction:PWM修改方向
uint16_t:DutyIncremental:修改的增量
*出口参数:
ErrorStatus:操作成功/失败
*****************************************************/
ErrorStatus PWM_ComplementaryMode_DutyChange(PWM_ComplementaryOutputPin_TypeDef PWM_ComplementaryOutputPin,
    PWM_DutyChange_TypeDef Change_Direction, uint16_t DutyIncremental)
{
  uint8_t tmpRegValue;
  uint16_t tmpPolarity = PWMPDL + (PWMPDH << 8);

  tmpRegValue = PWMREG[PWM_ComplementaryOutputPin * 2];			//把当前占空比寄存器放进临时变量
  if(Change_Direction == PWM_DutyChange_Up)
  {
    tmpRegValue += DutyIncremental;				//占空比增加
  }
  else
  {
    tmpRegValue -= DutyIncremental;				//占空比减少
  }

  /* 计数器发生了向上溢出 */
  if(tmpRegValue > tmpPolarity)
    return ERROR;
  PWMREG[PWM_ComplementaryOutputPin] = tmpRegValue;		//占空比寄存器赋值
  return SUCCESS;
}

/**************************************************
*函数名称:void PWM_DeadTimeConfig(uint8_t PWM_RisingDeadTime, uint8_t PWM_FallingDeadTime)
*函数功能:PWM互补工作模式下死区时间配置函数
*入口参数:
uint8_t:PWM_RisingDeadTime:PWM死区上升时间00-FF
uint8_t:PWM_FallingDeadTime:PWM死区下降时间00-FF
*出口参数:void
**************************************************/
void PWM_DeadTimeConfig(uint8_t PWM_RisingDeadTime, uint8_t PWM_FallingDeadTime)
{
  PWMDFR = (PWM_RisingDeadTime | (PWM_FallingDeadTime << 4));
}

/**************************************************
*函数名称:PWM_DeadTimeConfigEX(PWM_Type_TypeDef PWM_Type,uint8_t PWM_RisingDeadTime, uint8_t PWM_FallingDeadTime)
*函数功能:PWM互补工作模式下死区时间配置函数-扩展版
*入口参数:
PWM_Type_TypeDef:PWM_Type:PWM源选择
uint8_t:PWM_RisingDeadTime:PWM死区上升时间	 00-FF
uint8_t:PWM_FallingDeadTime:PWM死区下降时间  00-FF
*出口参数:void
**************************************************/
void PWM_DeadTimeConfigEX(PWM_Type_TypeDef PWM_Type, uint8_t PWM_RisingDeadTime, uint8_t PWM_FallingDeadTime)
{
  if(PWM_Type == PWM0_Type)
  {
    PWMDFR = (PWM_RisingDeadTime | (PWM_FallingDeadTime << 4));
  }
}

/*****************************************************
*函数名称:void PWM_Cmd(FunctionalState NewState)
*函数功能:PWM功能开关函数
*入口参数:
FunctionalState:NewState:功能启动/关闭选择
*出口参数:void
*****************************************************/
void PWM_Cmd(FunctionalState NewState)
{
  if(NewState != DISABLE)
  {
    PWMCON0 |= 0X80;
  }
  else
  {
    PWMCON0 &= 0X7F;
  }
}

/*****************************************************
*函数名称:void PWM_Cmd(PWM_Type_TypeDef PWM_Type,FunctionalState NewState)
*函数功能:PWM功能开关函数
*入口参数:
PWM_Type_TypeDef:PWM_Type:PWM类型
FunctionalState:NewState:功能启动/关闭选择
*出口参数:void
*****************************************************/
void PWM_CmdEX(PWM_Type_TypeDef PWM_Type,
               FunctionalState NewState)
{
  if(PWM_Type == PWM0_Type)
  {
    if(NewState != DISABLE)
    {
      PWMCON0 |= 0X80;
    }
    else
    {
      PWMCON0 &= 0X7F;
    }
  }
}

/*****************************************************
*函数名称:void PWM_ITConfig(FunctionalState NewState, PriorityStatus Priority)
*函数功能:PWM中断初始化
*入口参数:
FunctionalState:NewState:中断使能/关闭选择
PriorityStatus:Priority:中断优先级选择
*出口参数:void
*****************************************************/
void PWM_ITConfig(FunctionalState NewState,
                  PriorityStatus Priority)
{
  if(NewState != DISABLE)
  {
    IE1 |= 0X02;
  }
  else
  {
    IE1 &= 0XFD;
  }

  if(Priority == LOW)
  {
    IP1 &= ~0X02;
  }
  else
  {
    IP1 |= 0X02;
  }
}

/*****************************************************
*函数名称:void PWM_ITConfigEX(PWM_Type_TypeDef PWM_Type,FunctionalState NewState, PriorityStatus Priority)
*函数功能:PWM中断配置函数-扩展版
*入口参数:
PWM_Type_TypeDef:PWM_Type:PWM源选择
FunctionalState:NewState:中断使能/关闭选择
PriorityStatus:Priority:中断优先级选择
*出口参数:void
*****************************************************/
void PWM_ITConfigEX(PWM_Type_TypeDef PWM_Type, FunctionalState NewState, PriorityStatus Priority)
{
  if(PWM_Type == PWM0_Type)
  {
    if(NewState != DISABLE)
    {
      IE1 |= 0X02;
    }
    else
    {
      IE1 &= 0XFD;
    }

    if(Priority == LOW)
    {
      IP1 &= ~0X02;
    }
    else
    {
      IP1 |= 0X02;
    }
  }
}

/*****************************************************
*函数名称:void PWM_IndependentModeConfigEX(PWM_OutputPin_TypeDef PWM_OutputPin, uint16_t PWM_DutyCycle, PWM_OutputState_TypeDef PWM_OutputState)
*函数功能:PWM独立模式占空比配置
*入口参数:
PWM_OutputPin_TypeDef:PWM_ComplementaryOutputPin:PWM通道
uint16_t:PWM_DutyCycle:PWM占空比配置
FunctionalState:NewState:功能启动/关闭选择
*出口参数:void
*****************************************************/
void PWM_IndependentModeConfigEX(PWM_OutputPin_TypeDef PWM_ComplementaryOutputPin,
                                 uint16_t PWM_DutyCycle,
                                 PWM_OutputState_TypeDef PWM_OutputState)
{
  PWM_IndependentModeConfig(PWM_ComplementaryOutputPin, PWM_DutyCycle); //配置占空比
  PWM_OutputStateConfig(PWM_ComplementaryOutputPin, PWM_OutputState);   //IO复用PWM配置函数
  if(PWM_OutputState == ENABLE)
  {
    PWM_CmdEX(PWM_ComplementaryOutputPin >> 4, ENABLE); //开启PWM
  }
}

/*****************************************************
*函数名称:void PWM_ComplementaryModeConfigEX(PWM_OutputPin_TypeDef PWM_OutputPin, uint16_t PWM_DutyCycle, PWM_OutputState_TypeDef PWM_OutputState)
*函数功能:PWM互补模式占空比配置
*入口参数:
PWM_ComplementaryOutputPin_TypeDef:PWM_OutputPin:PWM通道
uint16_t:PWM_DutyCycle:PWM占空比配置
FunctionalState:NewState:功能启动/关闭选择
*出口参数:void
*****************************************************/
void PWM_ComplementaryModeConfigEX(PWM_ComplementaryOutputPin_TypeDef PWM_OutputPin,
                                   uint16_t PWM_DutyCycle,
                                   PWM_OutputState_TypeDef PWM_OutputState)
{
  PWM_ComplementaryModeConfig(PWM_OutputPin, PWM_DutyCycle); //配置占空比
  PWM_OutputStateConfig(PWM_OutputPin, PWM_OutputState);     //IO复用PWM配置函数
  PWM_OutputStateConfig(PWM_OutputPin + 2, PWM_OutputState); //IO复用PWM配置函数
  if(PWM_OutputState == ENABLE)
  {
    PWM_CmdEX(PWM_OutputPin >> 4, ENABLE); //开启PWM
  }
}

/*****************************************************
*函数名称:PWM_GetFlagStatus(void)
*函数功能:获取PWM中断标志位
*入口参数:void
*出口参数:
FlagStatus：PWM中断标志位状态
*****************************************************/
FlagStatus PWM_GetFlagStatus(void)
{
  return (bool)(PWMCON0 & 0X40);
}

/*****************************************************
*函数名称:PWM_GetFlagStatusEX(PWM_Type_TypeDef PWM_Type)
*函数功能:获取PWM中断标志位-扩展版
*入口参数:
PWM_Type_TypeDef:PWM_Type:PWM源选择
*出口参数:void
*****************************************************/
FlagStatus PWM_GetFlagStatusEX(PWM_Type_TypeDef PWM_Type)
{
  if((PWM_Type == PWM0_Type))
  {
    return (bool)(PWMCON0 & 0X40);
  }

  return RESET;
}

/*****************************************************
*函数名称:void PWM_ClearFlag(void)
*函数功能:清除PWM0中断标志位
*入口参数:void
*出口参数:void
*****************************************************/
void PWM_ClearFlag(void)
{
  PWMCON0 &= ~0X40;
}

/*****************************************************
*函数名称:void PWM_ClearFlagEX(PWM_Type_TypeDef PWM_Type)
*函数功能:清除PWM中断-扩展版
*入口参数:
PWM_Type_TypeDef:PWM_Type:PWM源选择
*出口参数:void
*****************************************************/
void PWM_ClearFlagEX(PWM_Type_TypeDef PWM_Type)
{
  if((PWM_Type == PWM0_Type))
  {
    PWMCON0 &= ~0X40;
  }
}

/*****************************************************
*函数名称:FlagStatus PWM_GetFaultDetectionFlagStatus(void)
*函数功能:获得PWM故障检测标志位状态
*入口参数:void
*出口参数:
FlagStatus:PWM故障检测标志位状态
*****************************************************/
FlagStatus PWM_GetFaultDetectionFlagStatus(void)
{
  return (bool)(PWMFLT & 0X40);
}

/*****************************************************
*函数名称:FlagStatus PWM_GetFaultDetectionFlagStatus(void)
*函数功能:获得PWM故障检测标志位状态-扩展版
*入口参数:
PWM_Type_TypeDef:PWM_Type:PWM类型
*出口参数:
FlagStatus:PWM故障检测标志位状态
*****************************************************/
FlagStatus PWM_GetFaultDetectionFlagStatusEX(PWM_Type_TypeDef PWM_Type)
{
  if(PWM_Type == PWM0_Type)
  {
    return (bool)(PWMFLT & 0X40);
  }
  return RESET;
}

/*****************************************************
*函数名称:void PWM_ClearFaultDetectionFlag(void)
*函数功能:清除PWM故障检测标志位状态   // ！注意,处于锁存模式下，此位可软件清除
*入口参数:
PWM_Type_TypeDef:PWM_Type:PWM类型
*出口参数:void
*****************************************************/
void PWM_ClearFaultDetectionFlagEX(PWM_Type_TypeDef PWM_Type)
{
  if(PWM_Type == PWM0_Type)
  {
    PWMFLT &= 0XBF;
  }
}

/*****************************************************
*函数名称:void PWM_FaultDetectionConfig(FunctionalState NewState)
*函数功能:PWM故障检测功能开启/关闭
*入口参数:
FunctionalState:NewState:故障检测功能开启/关闭
*出口参数:void
*****************************************************/
void PWM_FaultDetectionConfig(FunctionalState NewState)
{
  if(NewState != DISABLE)
  {
    PWMFLT |= 0X80;
  }
  else
  {
    PWMFLT &= 0X7F;
  }
}

/*****************************************************
*函数名称:void PWM_FaultDetectionFunctionConfigEX(PWM_Type_TypeDef PWM_Type, FunctionalState NewState)
*函数功能:PWM故障检测功能开启/关闭-扩展版
*入口参数:
PWM_Type_TypeDef:PWM_Type:PWM类型选择
FunctionalState:NewState:故障检测功能开启/关闭
*出口参数:void
*****************************************************/
void PWM_FaultDetectionConfigEX(PWM_Type_TypeDef PWM_Type, FunctionalState NewState)
{
  if(PWM_Type == PWM0_Type)
  {
    if(NewState != DISABLE)
    {
      PWMFLT |= 0X80;
    }
    else
    {
      PWMFLT &= 0X7F;
    }
  }
}

/*****************************************************
*函数名称:void PWM_FaultDetectionModeConfig(PWM_FaultDetectionMode_TypeDef FaultDetectionMode,
*                                    PWM_FaultDetectionVoltageSelect_TypeDef FaultDetectionVoltageSelect,
*                                    PWM_FaultDetectionWaveFilteringTime_TypeDef FaultDetectionWaveFilteringTime)
*函数功能:PWM故障检测模式设置
*入口参数:
PWM_FaultDetectionMode_TypeDef:FaultDetectionMode:故障检测功能模式设置: 立即模式/锁存模式
PWM_FaultDetectionVoltageSelect_TypeDef:FaultDetectionVoltageSelect:故障检测电平选择
PWM_FaultDetectionWaveFilteringTime_TypeDef:FaultDetectionWaveFilteringTime:故障检测输入信号滤波时间选择
*出口参数:void
*****************************************************/
void PWM_FaultDetectionModeConfig(PWM_FaultDetectionMode_TypeDef FaultDetectionMode,
                                  PWM_FaultDetectionVoltageSelect_TypeDef FaultDetectionVoltageSelect,
                                  PWM_FaultDetectionWaveFilteringTime_TypeDef FaultDetectionWaveFilteringTime)
{
  PWMFLT = (PWMFLT & 0XC0) | FaultDetectionMode | FaultDetectionVoltageSelect |
           FaultDetectionWaveFilteringTime;
}

/*****************************************************
*函数名称:void PWM_FaultDetectionModeConfigEX(PWM_Type_TypeDef PWM_Type, PWM_FaultDetectionMode_TypeDef FaultDetectionMode, PWM_FaultDetectionVoltageSelect_TypeDef FaultDetectionVoltageSelect, PWM_FaultDetectionWaveFilteringTime_TypeDef FaultDetectionWaveFilteringTime)
*函数功能:PWM故障检测模式设置
*入口参数:
PWM_Type_TypeDef:PWM_Type:PWM类型选择
PWM_FaultDetectionMode_TypeDef:FaultDetectionMode:故障检测功能模式设置: 立即模式/锁存模式
PWM_FaultDetectionVoltageSelect_TypeDef:FaultDetectionVoltageSelect:故障检测电平选择
PWM_FaultDetectionWaveFilteringTime_TypeDef:FaultDetectionWaveFilteringTime:故障检测输入信号滤波时间选择
*出口参数:void
*****************************************************/
void PWM_FaultDetectionModeConfigEX(PWM_Type_TypeDef PWM_Type,
                                    PWM_FaultDetectionMode_TypeDef FaultDetectionMode,
                                    PWM_FaultDetectionVoltageSelect_TypeDef FaultDetectionVoltageSelect,
                                    PWM_FaultDetectionWaveFilteringTime_TypeDef FaultDetectionWaveFilteringTime)
{
  if(PWM_Type == PWM0_Type)
  {
    PWMFLT = (PWMFLT & 0XC0) | FaultDetectionMode | FaultDetectionVoltageSelect |
             FaultDetectionWaveFilteringTime;
  }
}

#endif

#if defined (RD8G403)
/**************************************************
*函数名称:void PWM_DeInit(void)
*函数功能:PWM相关寄存器复位至缺省值
*入口参数:void
*出口参数:void
**************************************************/
void PWM_DeInit(void)
{
  PWMCFG = 0X00;
  PWMCON0 = 0X00;
  PWMPRD = 0X00;
  PWMDTYA = 0X00;
  PWMDTY0 = 0X00;
  PWMDTY1 = 0X00;
  PWMDTY2 = 0X00;
  PWMCON1 = 0X00;
  PWMDTYB = 0X00;
  PWMDTY3 = 0X00;
  PWMDTY4 = 0X00;
  PWMDTY5 = 0X00;
  PWMDTY6 = 0X00;
  IE1 &= 0XFD;
  IP1 &= 0XFD;
}

/**************************************************
*函数名称:void PWM_Init(PWM_PresSel_TypeDef PWM_PresSel, uint16_t PWM_Period)
*函数功能:PWM初始化配置函数
*入口参数:
PWM_PresSel_TypeDef:PWM_PresSel:预分频选择
uint16_t:PWM_Period:PWM周期配置
*出口参数:void
**************************************************/
void PWM_Init(PWM_PresSel_TypeDef PWM_PresSel,
              uint16_t PWM_Period)
{
  PWM_Period -= 1;
  PWMCON0 = (PWMCON0 & 0XCC) | PWM_PresSel |
            (uint8_t)(PWM_Period &
                      0X0003);	//预分频及周期的低2位
  PWMPRD = (uint8_t)(PWM_Period >>
                     2);									    //周期高八位
}

/**************************************************
*函数名称:void PWM_OutputStateConfig(uint8_t PWM_OutputPin, PWM_OutputState_TypeDef PWM_OutputState)
*函数功能:PWMx输出使能/失能配置函数
*入口参数:
PWM_OutputPin_TypeDef:PWM_OutputPin:PWMx选择
PWM_OutputState_TypeDef:PWM_OutputState:PWM输出状态配置
*出口参数:void
**************************************************/
void PWM_OutputStateConfig(uint8_t PWM_OutputPin,
                           PWM_OutputState_TypeDef PWM_OutputState)
{
  if(PWM_OutputState == PWM_OUTPUTSTATE_ENABLE)
  {
    PWMCON1 |= PWM_OutputPin;
  }
  else
  {
    PWMCON1 &= (~PWM_OutputPin);
  }
}

/**************************************************
*函数名称:void PWM_PWM2Selection(PWM2_OutputPin_TypeDef PWM2_OutputPin)
*函数功能:PWM2管脚选择函数
*入口参数:
PWM2_OutputPin_TypeDef:PWM2_OutputPin:PWM2管脚选择
*出口参数:void
**************************************************/
void PWM_PWM2Selection(PWM2_OutputPin_TypeDef
                       PWM2_OutputPin)
{
  PWMCON0 = PWMCON0 & 0XFB | PWM2_OutputPin;
}

/**************************************************
*函数名称:void PWM_PWM5Selection(PWM5_OutputPin_TypeDef PWM5_OutputPin)
*函数功能:PWM5管脚选择函数
*入口参数:
PWM5_OutputPin_TypeDef:PWM5_OutputPin:PWM5管脚选择
*出口参数:void
**************************************************/
void PWM_PWM5Selection(PWM5_OutputPin_TypeDef
                       PWM5_OutputPin)
{
  PWMCON0 = PWMCON0 & 0XF7 | PWM5_OutputPin;
}

/**************************************************
*函数名称:void PWM_PolarityConfig(uint8_t PWM_OutputPin, PWM_Polarity_TypeDef PWM_Polarity)
*函数功能:PWMx正/反向输出配置函数
*入口参数:
PWM_OutputPin_TypeDef:PWM_OutputPin:PWMx选择
PWM_Polarity_TypeDef:PWM_Polarity:PWM输出正/反向配置
*出口参数:void
**************************************************/
void PWM_PolarityConfig(uint8_t PWM_OutputPin,
                        PWM_Polarity_TypeDef PWM_Polarity)
{
  if(PWM_Polarity == PWM_POLARITY_INVERT)
  {
    PWMCFG |= PWM_OutputPin;
  }
  else
  {
    PWMCFG &= (~PWM_OutputPin);
  }
}

/**************************************************
*函数名称:void PWM_IndependentModeConfig(PWM_OutputPin_TypeDef PWM_OutputPin, uint16_t PWM_DutyCycle)
*函数功能:PWMx独立工作模式配置函数
*入口参数:
PWM_OutputPin_TypeDef:PWM_OutputPin:PWMx独立通道选择
uint16_t:PWM_DutyCycle:PWM占空比配置
*出口参数:void
**************************************************/
void PWM_IndependentModeConfig(PWM_OutputPin_TypeDef PWM_OutputPin,
                               uint16_t PWM_DutyCycle)
{
  if(PWM_OutputPin != PWM6)
  {
    PWMCON1 &= 0X7F;		//设置PWM为独立模式
  }

  switch(PWM_OutputPin)	//设置占空比
  {
    case PWM0:
      PWMDTYA = PWMDTYA & 0XFC | (PWM_DutyCycle % 4);
      PWMDTY0 = (uint8_t)(PWM_DutyCycle >> 2);
      break;

    case PWM1:
      PWMDTYA = PWMDTYA & 0XF3 | ((PWM_DutyCycle % 4) <<
                                  2);
      PWMDTY1 = (uint8_t)(PWM_DutyCycle >> 2);
      break;

    case PWM2:
      PWMDTYA = PWMDTYA & 0XCF | ((PWM_DutyCycle % 4) <<
                                  4);
      PWMDTY2 = (uint8_t)(PWM_DutyCycle >> 2);
      break;

    case PWM3:
      PWMDTYA = PWMDTYA & 0X3F | ((PWM_DutyCycle % 4) <<
                                  6);
      PWMDTY3 = (uint8_t)(PWM_DutyCycle >> 2);
      break;

    case PWM4:
      PWMDTYB = PWMDTYB & 0XFC | (PWM_DutyCycle % 4);
      PWMDTY4 = (uint8_t)(PWM_DutyCycle >> 2);
      break;

    case PWM5:
      PWMDTYB = PWMDTYB & 0XF3 | ((PWM_DutyCycle % 4) <<
                                  2);
      PWMDTY5 = (uint8_t)(PWM_DutyCycle >> 2);
      break;

    case PWM6:
      PWMDTYB = PWMDTYB & 0XCF | ((PWM_DutyCycle % 4) <<
                                  4);
      PWMDTY6 = (uint8_t)(PWM_DutyCycle >> 2);
      break;

    default:
      break;
  }
}

/*****************************************************
*函数名称:ErrorStatus PWM_IndependentMode_DutyChange(PWM_OutputPin_TypeDef PWM_OutputPin,
																						PWM_DutyChange_TypeDef Change_Direction,
																						uint16_t DutyIncremental)
*函数功能:PWM独立模式占空比修改
*入口参数:
PWM_OutputPin_TypeDef:PWM_OutputPin:待修改的PWM独立通道
PWM_DutyChange_TypeDef:Change_Direction:PWM修改方向
uint16_t:DutyIncremental:修改的增量
*出口参数:
ErrorStatus:操作成功/失败
*****************************************************/
ErrorStatus PWM_IndependentMode_DutyChange(PWM_OutputPin_TypeDef PWM_OutputPin,
    PWM_DutyChange_TypeDef Change_Direction,
    uint16_t DutyIncremental)
{
  uint16_t tmpRegValue;
  uint16_t tmpPolarity = ((PWMCON0 & 0x03) | (PWMPRD << 2));

  switch(PWM_OutputPin)	//设置占空比
  {
    case PWM0:
      tmpRegValue = ((PWMDTYA & 0xfc) | (PWMDTY0 << 2));
      break;

    case PWM1:
      tmpRegValue = (((PWMDTYA & 0xf3) >> 2) | (PWMDTY1 << 2));
      break;

    case PWM2:
      tmpRegValue = (((PWMDTYA & 0xcf) >> 4) | (PWMDTY2 << 2));
      break;

    case PWM3:
      tmpRegValue = (((PWMDTYA & 0x3f) >> 6) | (PWMDTY2 << 2));
      break;

    case PWM4:
      tmpRegValue = (((PWMDTYB & 0xfc)) | (PWMDTY3 << 2));
      break;

    case PWM5:
      tmpRegValue = (((PWMDTYB & 0xf3) >> 2) | (PWMDTY4 << 2));
      break;

    case PWM6:
      tmpRegValue = (((PWMDTYB & 0xcf) >> 4) | (PWMDTY5 << 2));
      break;

    default:
      break;
  }

  if(Change_Direction == PWM_DutyChange_Up)
  {
    tmpRegValue += DutyIncremental;				//占空比增加
  }
  else
  {
    tmpRegValue -= DutyIncremental;				//占空比减少
  }

  /* 计数器发生了溢出 */
  if(tmpRegValue > tmpPolarity)
    return ERROR;

  switch(PWM_OutputPin)	//设置占空比
  {
    case PWM0:
      PWMDTYA = PWMDTYA & 0xfc | (tmpRegValue % 4);
      PWMDTY0 = (uint8_t)(tmpRegValue >> 2);
      break;

    case PWM1:
      PWMDTYA = PWMDTYA & 0xf3 | ((tmpRegValue % 4) << 2);
      PWMDTY1 = (uint8_t)(tmpRegValue >> 2);
      break;

    case PWM2:
      PWMDTYA = PWMDTYA & 0xcf | ((tmpRegValue % 4) << 4);
      PWMDTY2 = (uint8_t)(tmpRegValue >> 2);
      break;

    case PWM3:
      PWMDTYA = PWMDTYA & 0x3f | ((tmpRegValue % 4) << 6);
      PWMDTY2 = (uint8_t)(tmpRegValue >> 2);
      break;

    case PWM4:
      PWMDTYB = PWMDTYB & 0xfc | (tmpRegValue % 4);
      PWMDTY3 = (uint8_t)(tmpRegValue >> 2);
      break;

    case PWM5:
      PWMDTYB = PWMDTYB & 0xf3 | ((tmpRegValue % 4) << 2);
      PWMDTY4 = (uint8_t)(tmpRegValue >> 2);
      break;

    case PWM6:
      PWMDTYB = PWMDTYB & 0xcf | ((tmpRegValue % 4) << 4);
      PWMDTY5 = (uint8_t)(tmpRegValue >> 2);
      break;

    default:
      break;
  }
  return SUCCESS;
}

/**************************************************
*函数名称:void PWM_ComplementaryModeConfig(PWM_ComplementaryOutputPin_TypeDef PWM_ComplementaryOutputPin, uint16_t PWM_DutyCycle)
*函数功能:PWMxPWMy互补工作模式配置函数
*入口参数:
PWM_ComplementaryOutputPin_TypeDef:PWM_ComplementaryOutputPin:PWMxPWMy互补通道选择
uint16_t:PWM_DutyCycle:PWM占空比配置
*出口参数:void
**************************************************/
void PWM_ComplementaryModeConfig(PWM_ComplementaryOutputPin_TypeDef PWM_ComplementaryOutputPin,
                                 uint16_t PWM_DutyCycle)
{
  PWMCON1 |= 0X80;					//设置PWM为互补模式

  switch(PWM_ComplementaryOutputPin)	//设置占空比
  {
    case PWM0PWM3:
      PWMDTYA = PWMDTYA & 0XFC | (PWM_DutyCycle % 4);
      PWMDTY0 = (uint8_t)(PWM_DutyCycle >> 2);
      break;

    case PWM1PWM4:
      PWMDTYA = PWMDTYA & 0XF3 | ((PWM_DutyCycle % 4) <<
                                  2);
      PWMDTY1 = (uint8_t)(PWM_DutyCycle >> 2);
      break;

    case PWM2PWM5:
      PWMDTYA = PWMDTYA & 0XCF | ((PWM_DutyCycle % 4) <<
                                  4);
      PWMDTY2 = (uint8_t)(PWM_DutyCycle >> 2);
      break;

    default:
      break;
  }
}

/*****************************************************
*函数名称:void PWM_ComplementaryMode_DutyChange(PWM_OutputPin_TypeDef PWM_OutputPin,
																						PWM_DutyChange_TypeDef Change_Direction,
																						uint16_t DutyIncremental)
*函数功能:PWM互补模式占空比修改
*入口参数:
PWM_ComplementaryOutputPin_TypeDef:PWM_ComplementaryOutputPin:待修改的PWM互补通道
PWM_DutyChange_TypeDef:Change_Direction:PWM修改方向
uint16_t:DutyIncremental:修改的增量
*出口参数:
ErrorStatus:操作成功/失败
*****************************************************/
ErrorStatus PWM_ComplementaryMode_DutyChange(PWM_ComplementaryOutputPin_TypeDef PWM_ComplementaryOutputPin,
    PWM_DutyChange_TypeDef Change_Direction,
    uint16_t DutyIncremental)
{
  uint16_t tmpRegValue;
  uint16_t tmpPolarity = ((PWMCON0 & 0x03) | (PWMPRD << 2));

  switch(PWM_ComplementaryOutputPin)	//设置占空比
  {
    case PWM0PWM3:
      tmpRegValue = ((PWMDTYA & 0xfc) | (PWMDTY0 << 2));
      break;

    case PWM1PWM4:
      tmpRegValue = (((PWMDTYA & 0xf3) >> 2) | (PWMDTY1 << 2));
      break;

    case PWM2PWM5:
      tmpRegValue = (((PWMDTYA & 0xcf) >> 4) | (PWMDTY2 << 2));
      break;

    default:
      break;
  }

  if(Change_Direction == PWM_DutyChange_Up)
  {
    tmpRegValue += DutyIncremental;				//占空比增加
  }
  else
  {
    tmpRegValue -= DutyIncremental;				//占空比减少
  }

  /* 计数器发生了溢出 */
  if(tmpRegValue > tmpPolarity)
    return ERROR;

  switch(PWM_ComplementaryOutputPin)	//设置占空比
  {
    case PWM0PWM3:
      PWMDTYA = PWMDTYA & 0xfc | (tmpRegValue % 4);
      PWMDTY0 = (uint8_t)(tmpRegValue >> 2);
      break;

    case PWM1PWM4:
      PWMDTYA = PWMDTYA & 0xf3 | ((tmpRegValue % 4) << 2);
      PWMDTY1 = (uint8_t)(tmpRegValue >> 2);
      break;

    case PWM2PWM5:
      PWMDTYA = PWMDTYA & 0xcf | ((tmpRegValue % 4) << 4);
      PWMDTY2 = (uint8_t)(tmpRegValue >> 2);
      break;

    default:
      break;
  }
  return SUCCESS;
}

/**************************************************
*函数名称:void PWM_DeadTimeConfig(uint8_t PWM012_RisingDeadTime, uint8_t PWM345_fallingDeadTime)
*函数功能:PWM互补工作模式下死区时间配置函数
*入口参数:
uint8_t:PWM012_RisingDeadTime:PWM死区上升时间
uint8_t:PWM345_fallingDeadTime:PWM死区下降时间
*出口参数:void
**************************************************/
void PWM_DeadTimeConfig(uint8_t
                        PWM012_RisingDeadTime,
                        uint8_t PWM345_fallingDeadTime)
{
  PWMDTY3 = (PWM012_RisingDeadTime |
             (PWM345_fallingDeadTime << 4));
}

/*****************************************************
*函数名称:void PWM_Cmd(FunctionalState NewState)
*函数功能:PWM功能开关函数
*入口参数:
FunctionalState:NewState:功能启动/关闭选择
*出口参数:void
*****************************************************/
void PWM_Cmd(FunctionalState NewState)
{
  if(NewState != DISABLE)
  {
    PWMCON0 |= 0X80;
  }
  else
  {
    PWMCON0 &= ~0X80;
  }
}

/*****************************************************
*函数名称:void PWM_ITConfig(FunctionalState NewState, PriorityStatus Priority)
*函数功能:PWM中断初始化
*入口参数:
FunctionalState:NewState:中断使能/关闭选择
PriorityStatus:Priority:中断优先级选择
*出口参数:void
*****************************************************/
void PWM_ITConfig(FunctionalState NewState,
                  PriorityStatus Priority)
{
  if(NewState != DISABLE)
  {
    IE1 |= 0X02;
  }
  else
  {
    IE1 &= 0XFD;
  }

  if(Priority == LOW)
  {
    IP1 &= 0XFD;
  }
  else
  {
    IP1 |= 0X02;
  }
}

/*****************************************************
*函数名称:FlagStatus PWM_GetFlagStatus(void)
*函数功能:获得PWM中断标志状态
*入口参数:void
*出口参数:
FlagStatus:PWM中断标志状态
*****************************************************/
FlagStatus PWM_GetFlagStatus(void)
{
  return (bool)(PWMCON0 & 0X40);
}

/*****************************************************
*函数名称:void PWM_ClearFlag(void)
*函数功能:清除PWM中断标志状态
*入口参数:void
*出口参数:void
*****************************************************/
void PWM_ClearFlag(void)
{
  PWMCON0 &= 0XBF;
}

#endif

/******************* (C) COPYRIGHT 2022 RDS Microelectronics *****END OF FILE****/